# =============================================================================
# ShellCheck Workflow - Shell Script Linting
# =============================================================================
# This workflow runs ShellCheck on all shell scripts to ensure code quality
# and catch common shell scripting issues.
#
# Features:
#   - ShellCheck linting with warning severity
#   - Exit code validation for scripts
#   - Best practice enforcement
#   - Clear error reporting
# =============================================================================

name: ShellCheck

on:
  push:
    branches: [main, master]
    paths:
      - 'scripts/**/*.sh'
      - '.github/workflows/shellcheck.yml'
  pull_request:
    paths:
      - 'scripts/**/*.sh'
      - '.github/workflows/shellcheck.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # ===========================================================================
  # Shell Script Linting
  # ===========================================================================
  shellcheck:
    name: ShellCheck Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
          format: gcc

      - name: Verify error handling in scripts
        run: |
          echo "Checking shell scripts for proper error handling..."
          
          ISSUES_FOUND=false
          SCRIPTS_FOUND=false
          
          # Check if scripts directory exists and has .sh files
          if [ -d "scripts" ]; then
            shopt -s nullglob
            SCRIPT_LIST=(scripts/*.sh)
            shopt -u nullglob
            
            if [ ${#SCRIPT_LIST[@]} -eq 0 ]; then
              echo "No .sh files found in scripts/ directory"
            else
              SCRIPTS_FOUND=true
              for script in "${SCRIPT_LIST[@]}"; do
                if [ -f "$script" ]; then
                  echo "Checking: $script"
                  
                  # Check for set -e or set -euo pipefail
                  if ! grep -q "set -e" "$script" && ! grep -q "set -euo pipefail" "$script"; then
                    echo "::warning file=$script::Script may not have strict error handling (no 'set -e' or 'set -euo pipefail')"
                    ISSUES_FOUND=true
                  fi
                  
                  # Check for proper shebang
                  FIRST_LINE=$(head -1 "$script")
                  if [[ ! "$FIRST_LINE" =~ ^#!.*(bash|sh) ]]; then
                    echo "::warning file=$script::Script may be missing proper shebang"
                  fi
                fi
              done
            fi
          else
            echo "scripts/ directory not found"
          fi
          
          if [ "$SCRIPTS_FOUND" = false ]; then
            echo "✓ No shell scripts to check"
          elif [ "$ISSUES_FOUND" = true ]; then
            echo ""
            echo "Some scripts have warnings - see above for details"
          else
            echo "✓ All scripts have proper error handling"
          fi

      - name: Test script syntax
        run: |
          echo "Validating shell script syntax..."
          
          if [ -d "scripts" ]; then
            shopt -s nullglob
            SCRIPT_LIST=(scripts/*.sh)
            shopt -u nullglob
            
            if [ ${#SCRIPT_LIST[@]} -eq 0 ]; then
              echo "No .sh files found in scripts/ directory"
            else
              for script in "${SCRIPT_LIST[@]}"; do
                if [ -f "$script" ]; then
                  echo "Syntax check: $script"
                  bash -n "$script" || echo "::error file=$script::Syntax error in script"
                fi
              done
            fi
          else
            echo "scripts/ directory not found"
          fi
          
          echo "✓ Shell script syntax validation complete"
