# =============================================================================
# Security Scanning Workflow
# =============================================================================
# This workflow performs security scanning for dependencies across all ecosystems.
#
# Scans:
#   - Python: pip-audit for known vulnerabilities
#   - JavaScript: npm audit for known vulnerabilities
#   - Dependency review on PRs
#
# Schedule:
#   - Daily at 3 AM UTC
#   - On all PRs
#   - On pushes to main/master
# =============================================================================

name: Security Scan

on:
  push:
    branches: [main, master]
  pull_request:
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: read

jobs:
  # ===========================================================================
  # Python Security Audit
  # ===========================================================================
  python-security:
    name: Python Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit safety

      - name: Install project dependencies
        run: pip install -e .

      - name: Run pip-audit
        run: |
          echo "Running pip-audit for vulnerability scanning..."
          pip-audit --strict --desc || echo "::warning::pip-audit found vulnerabilities"
        continue-on-error: true

      - name: Run safety check
        run: |
          echo "Running safety check..."
          safety check --full-report || echo "::warning::safety found vulnerabilities"
        continue-on-error: true

  # ===========================================================================
  # JavaScript Security Audit
  # ===========================================================================
  js-security:
    name: JavaScript Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=moderate || echo "::warning::npm audit found vulnerabilities"
        continue-on-error: true

      - name: Check for outdated packages
        run: |
          echo "Checking for outdated packages..."
          npm outdated || true

  # ===========================================================================
  # Dependency Review (PRs only)
  # ===========================================================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, MPL-2.0

  # ===========================================================================
  # Security Summary
  # ===========================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [python-security, js-security]
    if: always()
    steps:
      - name: Security scan summary
        run: |
          echo "=== Security Scan Summary ==="
          echo ""
          echo "Python Security: ${{ needs.python-security.result }}"
          echo "JavaScript Security: ${{ needs.js-security.result }}"
          echo ""
          if [ "${{ needs.python-security.result }}" == "success" ] && [ "${{ needs.js-security.result }}" == "success" ]; then
            echo "✅ All security scans completed successfully"
          else
            echo "⚠️ Some security scans reported issues - review the logs above"
          fi
